<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FIGHT</title>
        <script src="../database/players.js"></script>
        <script src="../database/database.js"></script>
        <link rel="stylesheet" href="menu.css">
        <link rel="stylesheet" href="../Teams/teams.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    </head>

    <body>
        <form id="fight_form_fight">
            <label for="red_corner_search">Red Corner</label>
            <input type="text" id="red_corner_search" placeholder="Type player's name">
            <div id="red_corner_suggestions" class="suggestions"></div>

            <label for="blue_corner_search">Blue Corner</label>
            <input type="text" id="blue_corner_search" placeholder="Type player's name">
            <div id="blue_corner_suggestions" class="suggestions"></div>
            <input type="submit">
        </form>

        <div class="corner_container">
            <div id="red_corner"></div>
            <div>
                <div>
                    <p id="crit"></p>
                    <p id="damage"></p>
                </div>
                <form id="attack-form">
                    <label>Turn</label>
                    <select id="attacker">
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                    </select>
                    <lable>Action</lable>
                    <select id="actioner">
                        <option>Attack</option>
                        <option>Elemental Attack</option>
                        <option>Special Ability</option>
                        <option>Update HP</option>
                    </select>
                    <input type="submit">
                </form>
            </div>
            <div id="blue_corner"></div>
        </div>
    </body>

    <script>
        let databaseArr = database;

        let blueAttack
        let blueDefense
        let blueCrit
        let blueElmAttack
        let blueElmDef
        let blueElmEffc
        let blueHp
        let blueStrength
        let bluePotency
        let blueBuff

        let redAttack
        let redDefense
        let redCrit
        let redElmAttack
        let redElmDef
        let redElmEffc
        let redHp
        let redStrength
        let redPotency
        let redBuff

        function buff(buff) {

            buff = buff / 100
            console.log(buff, 'aydin')
            isBuff = Math.random() < buff;
            if (isBuff) {
                alert('Update Stat !!')
                $('#damage').text('SUCCESS')
            } else {
                $('#damage').text('Fail')
            }
        }

        function updateHealth() {
            let red_corn_hp = prompt('red hp')
            let blue_corn_hp = prompt('blue hp')
            $('#redHP').text(red_corn_hp)
            $('#blueHP').text(blue_corn_hp)
        }


        function attack(e) {
            e.preventDefault();
            attacker = $('#attacker').val();
            action = $('#actioner').val();
            let currBlueHp = parseInt($('#blueHP').text(), 10);
            let currRedHp = parseInt($('#redHP').text(), 10);



            console.log('Red Stats:', { redAttack, redDefense, redCrit, redElmAttack, redElmDef, redElmEffc, redHp, redStr, redPot });
            console.log('Blue Stats:', { blueAttack, blueDefense, blueCrit, blueElmAttack, blueElmDef, blueElmEffc, blueHp, blueStr, bluePot });


            let variance = Math.random() * 0.2 - 0.1;
            if (action == 'Update HP') {
                updateHealth()
            }
            if (action == 'Special Ability') {
                if (attacker == 'red') {
                    console.log('a buff has been used!')
                    buff(redBuff)
                }

            }
            if (action === 'Attack') {
                let isCritical;
                let criticalMultiplier;

                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!buff updates go here:::::::::::::::::::::::::::::::::::::
                redAttack = 382
                console.log(redAttack)

                if (attacker === 'red') {
                    isCritical = Math.random() < redCrit;
                    criticalMultiplier = isCritical ? redStr : 1.0;
                    console.log('Red Strength (after applying multiplier):', redStr);
                    let damage = ((redAttack * (1 + variance)) - (blueDefense / 2)) * criticalMultiplier;
                    damage = Math.max(1, Math.round(damage));
                    $('#damage').text(damage);
                    $('#blueHP').text(currBlueHp - damage);
                    $('#crit').text(isCritical ? '💥🔥👊' : '');
                } else {
                    isCritical = Math.random() < blueCrit;
                    criticalMultiplier = isCritical ? blueStr : 1.0;
                    console.log('Blue Strength (after applying multiplier):', blueStr);
                    let damage = ((blueAttack * (1 + variance)) - (redDefense / 2)) * criticalMultiplier;
                    damage = Math.max(1, Math.round(damage));
                    $('#damage').text(damage);
                    $('#redHP').text(currRedHp - damage);
                    $('#crit').text(isCritical ? '💥🔥👊' : '');
                }
            }
        }





        $('#attack-form').submit(attack)

        function action(e) {
            e.preventDefault();
            let val_1 = $('#red_corner_search').val();
            let val_2 = $('#blue_corner_search').val();

            let redHtml = '';
            let blueHtml = '';

            for (let player of databaseArr) {
                if (val_1 === player.name) {
                    redHtml = `
            <div class='fight_time_card'>
                <div class='fight_corner_header'>
                    <p>${player.name}</p>
                    <img class='elem_img_corner' src='${player.elm}'>
                </div>
                <img id='fight_corner_img' src='${player.image}'>
                <h4 contenteditable="true">🖤 <span id='redHP'>${player.hp}</span></h4>
                <p>${player.nen_type}</p>
                <div class='fight_corner_stats'>
                    <p contenteditable="true">⚔️: <span id="redAttack">${player.attack}</span></p>
                    <p contenteditable="true">🛡: <span id="redDefense">${player.defense}</span></p>
                    <p contenteditable="true">💥: <span id="redCritical">${player.critical}</span></p>
                    <p contenteditable="true">🔥: <span id="redElmAttack">${player.elm_attack}</span></p>
                    <p contenteditable="true">㊏: <span id="redElmDefense">${player.elm_defense}</span></p>
                    <p contenteditable="true">🧪: <span id="redElmEfficiency">${player.elm_efficiency}</span></p>
                    <p contenteditable="true">🪦: <span id="redStrength">${player.strength}</span></p>
                    <p contenteditable="true">🌪: <span id="redPotency">${player.potency}</span></p>
                </div>
                <p>${player.buff} ✮ <span id='buff_red'>${player.buff_acc}%</span></p>
            </div>
            `;
                    redAttack = player.attack;
                    redDefense = player.defense;
                    redCrit = player.critical;
                    redElmAttack = player.elm_attack;
                    redElmDef = player.elm_defense;
                    redElmEffc = player.elm_efficiency;
                    redHp = player.hp;
                    redStr = player.strength;
                    redPot = player.potency;
                    redBuff = player.buff_acc

                } else if (val_2 === player.name) {
                    blueHtml = `
            <div class='fight_time_card'>
                <div class='fight_corner_header'>
                    <p>${player.name}</p>
                    <img class='elem_img_corner' src='${player.elm}'>
                </div>
                <img id='fight_corner_img' src='${player.image}'>
                <h4 contenteditable="true">🖤 <span id='blueHP'>${player.hp}</span></h4>
                <p>${player.nen_type}</p>
                <div class='fight_corner_stats'>
                    <p contenteditable="true">⚔️: <span id="blueAttack">${player.attack}</span></p>
                    <p contenteditable="true">🛡: <span id="blueDefense">${player.defense}</span></p>
                    <p contenteditable="true">💥: <span id="blueCritical">${player.critical}</span></p>
                    <p contenteditable="true">🔥: <span id="blueElmAttack">${player.elm_attack}</span></p>
                    <p contenteditable="true">㊏: <span id="blueElmDefense">${player.elm_defense}</span></p>
                    <p contenteditable="true">🧪: <span id="blueElmEfficiency">${player.elm_efficiency}</span></p>
                    <p contenteditable="true">🪦: <span id="blueStrength">${player.strength}</span></p>
                    <p contenteditable="true">🌪: <span id="bluePotency">${player.potency}</span></p>

                </div>
               <p>${player.buff} ✮ <span id='buff_red'>${player.buff_acc}%</span></p>
            </div>
            `;
                    blueAttack = player.attack;
                    blueDefense = player.defense;
                    blueCrit = player.critical;
                    blueElmAttack = player.elm_attack;
                    blueElmDef = player.elm_defense;
                    blueElmEffc = player.elm_efficiency;
                    blueHp = player.hp;
                    blueStr = player.strength;
                    bluePot = player.potency;
                    blueBuff = player.buff_acc
                }
            }

            $('#red_corner').html(redHtml);
            $('#blue_corner').html(blueHtml);

            console.log('Red Stats:', { redAttack, redDefense, redCrit, redElmAttack, redElmDef, redElmEffc, redHp, redStr, redPot });
            console.log('Blue Stats:', { blueAttack, blueDefense, blueCrit, blueElmAttack, blueElmDef, blueElmEffc, blueHp, blueStr, bluePot });
        }



        function filterSuggestions(inputId, suggestionsId, team) {
            $(inputId).on('input', function () {
                let filter = $(this).val().toLowerCase();
                let suggestions = $(suggestionsId);
                suggestions.empty(); // Clear previous suggestions

                if (filter) {
                    for (let player of team) {
                        if (player.name.toLowerCase().includes(filter)) {
                            suggestions.append(`<div>${player.name}</div>`);
                        }
                    }
                }

                // Handle clicking on a suggestion
                $(suggestionsId).on('click', 'div', function () {
                    $(inputId).val($(this).text()); // Set input to selected suggestion
                    suggestions.empty(); // Clear suggestions
                });
            });
        }

        // Apply filtering for red and blue corners
        filterSuggestions('#red_corner_search', '#red_corner_suggestions', databaseArr);
        filterSuggestions('#blue_corner_search', '#blue_corner_suggestions', databaseArr);


        $('#fight_form_fight').submit(action)
    </script>

</html>
