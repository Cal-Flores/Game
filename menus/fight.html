<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FIGHT</title>
        <script src="../database/players.js"></script>
        <script src="../database/database.js"></script>
        <link rel="stylesheet" href="menu.css">
        <link rel="stylesheet" href="../Teams/teams.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    </head>

    <body>
        <form id="fight_form_fight">
            <label for="red_corner_search">Red Corner</label>
            <input type="text" id="red_corner_search" placeholder="Type player's name">
            <div id="red_corner_suggestions" class="suggestions"></div>

            <label for="blue_corner_search">Blue Corner</label>
            <input type="text" id="blue_corner_search" placeholder="Type player's name">
            <div id="blue_corner_suggestions" class="suggestions"></div>
            <input type="submit">
        </form>

        <div class="corner_container">
            <div id="red_corner"></div>
            <div>
                <div>
                    <p id="crit"></p>
                    <p id="damage"></p>
                </div>
                <form id="attack-form">
                    <label>Turn</label>
                    <select id="attacker">
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                    </select>
                    <lable>Action</lable>
                    <select id="actioner">
                        <option>Attack</option>
                        <option>Elemental Attack</option>
                        <option>Ninjutsu</option>
                        <option>Special Attack</option>
                        <option>Nen Attack</option>
                        <option>Update HP</option>
                    </select>
                    <input type="submit">
                </form>
            </div>
            <div id="blue_corner"></div>
        </div>
    </body>

    <script>
        let databaseArr = database;

        let blueAttack
        let blueDefense
        let blueCrit
        let blueElmAttack
        let blueElmDef
        let blueElmEffc
        let blueHp
        let blueStrength
        let bluePotency
        let blueBuff
        let blueBuff2
        let blueELM
        let blueChakra
        let blueRecovery
        let blueCost

        let redAttack
        let redDefense
        let redCrit
        let redElmAttack
        let redElmDef
        let redElmEffc
        let redHp
        let redStrength
        let redPotency
        let redBuff
        let redBuff2
        let redELM
        let redChakra
        let redRecovery
        let redCost

        const elementalWeaknesses = {
            Water: 'Fire',
            Fire: 'Wind',
            Wind: 'Lightning',
            Lightning: 'Earth',
            Earth: 'Water'
        };
        function checkWeakness(attackerElement, defenderElement) {
            return elementalWeaknesses[attackerElement] == defenderElement;
        }


        function buff(buff) {
            buff = buff / 100;
            isBuff = Math.random() < buff;
            if (isBuff) {
                alert('success');
                let stat_max = prompt('STAT? redAttack, redDefense, redCrit, redElmAttack, redElmDef, redElmEffc, redHp, redStr, redPot, redELM, blueAttack, blueDefense, blueCrit, blueElmAttack, blueElmDef, blueElmEffc, blueHp, blueStr, bluePot, blueELM');
                console.log('stat_max is ', stat_max);
                let stat_type = prompt('Increase or Decrease');
                let stat_number = parseFloat(prompt('By how much'));

                switch (stat_max) {
                    case 'redAttack':
                        if (stat_type == 'Increase') {
                            redAttack = (redAttack * (1 + stat_number));
                        } else {
                            redAttack = (redAttack * (1 - stat_number));
                        }
                        break;
                    case 'redDefense':
                        if (stat_type == 'Increase') {
                            redDefense = (redDefense * (1 + stat_number));
                        } else {
                            redDefense = (redDefense * (1 - stat_number));
                        }
                        break;
                    case 'redCrit':
                        if (stat_type == 'Increase') {
                            redCrit = (redCrit * (1 + stat_number));
                        } else {
                            redCrit = (redCrit * (1 - stat_number));
                        }
                        break;
                    case 'redElmAttack':
                        if (stat_type == 'Increase') {
                            redElmAttack = (redElmAttack * (1 + stat_number));
                        } else {
                            redElmAttack = (redElmAttack * (1 - stat_number));
                        }
                        break;
                    case 'redElmDef':
                        if (stat_type == 'Increase') {
                            redElmDef = (redElmDef * (1 + stat_number));
                        } else {
                            redElmDef = (redElmDef * (1 - stat_number));
                        }
                        break;
                    case 'redElmEffc':
                        if (stat_type == 'Increase') {
                            redElmEffc = (redElmEffc * (1 + stat_number));
                        } else {
                            redElmEffc = (redElmEffc * (1 - stat_number));
                        }
                        break;
                    case 'redHp':
                        if (stat_type == 'Increase') {
                            redHp = (redHp * (1 + stat_number));
                        } else {
                            redHp = (redHp * (1 - stat_number));
                        }
                        break;
                    case 'redStr':
                        if (stat_type == 'Increase') {
                            redStr = (redStr * (1 + stat_number));
                        } else {
                            redStr = (redStr * (1 - stat_number));
                        }
                        break;
                    case 'redPot':
                        if (stat_type == 'Increase') {
                            redPot = (redPot * (1 + stat_number));
                        } else {
                            redPot = (redPot * (1 - stat_number));
                        }
                        break;
                    case 'redELM':
                        if (stat_type == 'Increase') {
                            redELM = (redELM * (1 + stat_number));
                        } else {
                            redELM = (redELM * (1 - stat_number));
                        }
                        break;
                    case 'blueAttack':
                        if (stat_type == 'Increase') {
                            blueAttack = (blueAttack * (1 + stat_number));
                        } else {
                            blueAttack = (blueAttack * (1 - stat_number));
                        }
                        break;
                    case 'blueDefense':
                        if (stat_type == 'Increase') {
                            blueDefense = (blueDefense * (1 + stat_number));
                        } else {
                            blueDefense = (blueDefense * (1 - stat_number));
                        }
                        break;
                    case 'blueCrit':
                        if (stat_type == 'Increase') {
                            blueCrit = (blueCrit * (1 + stat_number));
                        } else {
                            blueCrit = (blueCrit * (1 - stat_number));
                        }
                        break;
                    case 'blueElmAttack':
                        if (stat_type == 'Increase') {
                            blueElmAttack = (blueElmAttack * (1 + stat_number));
                        } else {
                            blueElmAttack = (blueElmAttack * (1 - stat_number));
                        }
                        break;
                    case 'blueElmDef':
                        if (stat_type == 'Increase') {
                            blueElmDef = (blueElmDef * (1 + stat_number));
                        } else {
                            blueElmDef = (blueElmDef * (1 - stat_number));
                        }
                        break;
                    case 'blueElmEffc':
                        if (stat_type == 'Increase') {
                            blueElmEffc = (blueElmEffc * (1 + stat_number));
                        } else {
                            blueElmEffc = (blueElmEffc * (1 - stat_number));
                        }
                        break;
                    case 'blueHp':
                        if (stat_type == 'Increase') {
                            blueHp = (blueHp * (1 + stat_number));
                        } else {
                            blueHp = (blueHp * (1 - stat_number));
                        }
                        break;
                    case 'blueStr':
                        if (stat_type == 'Increase') {
                            blueStr = (blueStr * (1 + stat_number));
                        } else {
                            blueStr = (blueStr * (1 - stat_number));
                        }
                        break;
                    case 'bluePot':
                        if (stat_type == 'Increase') {
                            bluePot = (bluePot * (1 + stat_number));
                        } else {
                            bluePot = (bluePot * (1 - stat_number));
                        }
                        break;
                    case 'blueELM':
                        if (stat_type == 'Increase') {
                            blueELM = (blueELM * (1 + stat_number));
                        } else {
                            blueELM = (blueELM * (1 - stat_number));
                        }
                        break;
                    default:
                        alert('Invalid stat');
                }


                // Update the stats on the page if necessary
                $('#redAttack').text(redAttack);
                $('#redDefense').text(redDefense);
                $('#redCrit').text(redCrit);
                $('#redElmAttack').text(redElmAttack);
                $('#redElmDef').text(redElmDef);
                $('#redElmEffc').text(redElmEffc);
                $('#redHp').text(redHp);
                $('#redStr').text(redStr);
                $('#redPot').text(redPot);
                $('#redELM').text(redELM);
                $('#blueAttack').text(blueAttack);
                $('#blueDefense').text(blueDefense);
                $('#blueCrit').text(blueCrit);
                $('#blueElmAttack').text(blueElmAttack);
                $('#blueElmDef').text(blueElmDef);
                $('#blueElmEffc').text(blueElmEffc);
                $('#blueHp').text(blueHp);
                $('#blueStr').text(blueStr);
                $('#bluePot').text(bluePot);
                $('#blueELM').text(blueELM);

            } else {
                $('#damage').text('Fail');
            }
        }
        function getRecovery(baseRecovery) {
            let variance = (Math.random() * 0.8) - 0.4;
            let rareMultiplier = Math.random();
            if (rareMultiplier > 0.95) {
                variance += 0.5; // 5% chance to add more variance
            } else if (rareMultiplier < 0.05) {
                variance -= 0.5; // 5% chance to reduce more
            }
            let newRecovery = baseRecovery * (1 + variance);
            return Math.max(0, Math.round(newRecovery));
        }


        function updateHealth() {
            let red_corn_hp = prompt('red hp')
            let blue_corn_hp = prompt('blue hp')
            $('#redHP').text(red_corn_hp)
            $('#blueHP').text(blue_corn_hp)
        }


        function attack(e) {
            e.preventDefault();
            attacker = $('#attacker').val();
            action = $('#actioner').val();
            let currBlueHp = parseInt($('#blueHP').text(), 10);
            let currRedHp = parseInt($('#redHP').text(), 10);
            let currBlueChakra = parseInt($('#blueChakra').text(), 10);
            let currRedChakra = parseInt($('#redChakra').text(), 10);



            console.log('Red Stats:', { redAttack, redDefense, redCrit, redElmAttack, redElmDef, redElmEffc, redHp, redStr, redPot, redELM, currRedChakra });
            console.log('Blue Stats:', { blueAttack, blueDefense, blueCrit, blueElmAttack, blueElmDef, blueElmEffc, blueHp, blueStr, bluePot, blueELM, currBlueChakra });

            let variance = Math.random() * 0.2 - 0.1;
            if (action == 'Elemental Attack') {
                if (attacker == 'red') {
                    let magicEffectiveness = 1.0;
                    if (checkWeakness(redELM, blueELM)) {
                        console.log('is weak');
                        magicEffectiveness = redElmEffc;
                    } else {
                        console.log('no weakness detected');
                    }
                    console.log('magic efffect multiplier is', magicEffectiveness)
                    let magicDamage = ((redElmAttack * (1 + variance)) - (blueElmDef / 2)) * magicEffectiveness * redPot;
                    magicDamage = Math.max(1, Math.round(magicDamage));
                    $('#damage').text(magicDamage);
                    $('#blueHP').text(currBlueHp - magicDamage);
                    $('#crit').text(magicEffectiveness != 1 ? '🔥⚡️💧🌱💨' : '');
                } else {
                    let magicEffectiveness = 1.0;
                    if (checkWeakness(blueELM, redELM)) {
                        console.log('is weak')
                        magicEffectiveness = blueElmEffc;
                    } else {
                        console.log('no weakness detected')
                    }
                    let magicDamage = ((blueElmAttack * (1 + variance)) - (redElmDef / 2)) * magicEffectiveness * bluePot;
                    magicDamage = Math.max(1, Math.round(magicDamage));
                    $('#damage').text(magicDamage);
                    $('#redHP').text(currRedHp - magicDamage);
                    $('#crit').text(magicEffectiveness != 1 ? '🔥⚡️💧🌱💨' : '');
                }
            }
            if (action == 'Update HP') {
                updateHealth()
            }
            if (action == 'Special Attack') {
                if (attacker == 'red') {
                    console.log('a buff has been used!')
                    buff(redBuff)
                } else {
                    console.log('a buff has been used!')
                    buff(blueBuff)
                }

            }
            if (action == 'Nen Attack') {
                if (attacker == 'red') {
                    console.log('a buff has been used!')
                    buff(redBuff2)
                } else {
                    console.log('a buff has been used!')
                    buff(blueBuff2)
                }
            }
            if (action == 'Ninjutsu') {
                if (attacker == 'red') {
                    console.log(currRedChakra)
                    if (currRedChakra < redCost) {
                        alert('NOT ENOUGH CHAKRA LOSE TURN')
                        return
                    }
                    currRedChakra -= redCost
                    $('#redChakra').text(currRedChakra)
                    $('#blueHP').text(currBlueHp - 1000);
                    return
                }
            }
            if (action === 'Attack') {
                let isCritical;
                let criticalMultiplier;



                if (attacker === 'red') {
                    isCritical = Math.random() < redCrit;
                    criticalMultiplier = isCritical ? redStr : 1.0;
                    console.log('!!!!!!!!!!!!!!!!!!Red Attack :', redAttack);
                    let damage = ((redAttack * (1 + variance)) - (blueDefense / 2.5)) * criticalMultiplier;
                    damage = Math.max(1, Math.round(damage));
                    $('#damage').text(damage);
                    $('#blueHP').text(currBlueHp - damage);
                    $('#crit').text(isCritical ? '💥🔥👊' : '');
                } else {
                    isCritical = Math.random() < blueCrit;
                    criticalMultiplier = isCritical ? blueStr : 1.0;
                    console.log('Blue Strength (after applying multiplier):', blueAttack);
                    let damage = ((blueAttack * (1 + variance)) - (redDefense / 2.5)) * criticalMultiplier;
                    damage = Math.max(1, Math.round(damage));
                    $('#damage').text(damage);
                    $('#redHP').text(currRedHp - damage);
                    $('#crit').text(isCritical ? '💥🔥👊' : '');
                }
            }
            currRedChakra += getRecovery(redRecovery);
            $('#redChakra').text(currRedChakra);

            currBlueChakra += getRecovery(blueRecovery);
            $('#blueChakra').text(currBlueChakra);
        }





        $('#attack-form').submit(attack)

        function action(e) {
            e.preventDefault();
            let val_1 = $('#red_corner_search').val();
            let val_2 = $('#blue_corner_search').val();

            let redHtml = '';
            let blueHtml = '';

            for (let player of databaseArr) {
                if (val_1 === player.name) {
                    redHtml = `
            <div class='fight_time_card'>
                <div class='fight_corner_header'>
                    <p>${player.name}</p>
                    <img class='elem_img_corner' src='${player.elm}'>
                </div>
                <img id='fight_corner_img' src='${player.image}'>
                <h4 contenteditable="true">🖤 <span id='redHP'>${player.hp}</span></h4>
                <p>${player.nen_type}</p>
                <div class='fight_corner_stats'>
                    <p contenteditable="true">⚔️: <span id="redAttack">${player.attack}</span></p>
                    <p contenteditable="true">🛡: <span id="redDefense">${player.defense}</span></p>
                    <p contenteditable="true">💥: <span id="redCrit">${player.critical}</span></p>
                    <p contenteditable="true">🔥: <span id="redElmAttack">${player.elm_attack}</span></p>
                    <p contenteditable="true">㊏: <span id="redElmDef">${player.elm_defense}</span></p>
                    <p contenteditable="true">🧪: <span id="redElmEffc">${player.elm_efficiency}</span></p>
                    <p contenteditable="true">🪦: <span id="redStr">${player.strength}</span></p>
                    <p contenteditable="true">🌪: <span id="redPot">${player.potency}</span></p>
                    <p contenteditable="true">☸️: <span id="redChakra">${player.chakra}</span></p>
                </div>
                <p>${player.chakra_attack} ✮ <span id='cost'>${player.cost}</span></p>
                <p>${player.buff} ✮ <span id='buff_red'>${player.buff_acc}%</span></p>
                <p>${player.buff2} ✮ <span id='buff_red'>${player.buff2_acc}%</span></p>
            </div>
            `;
                    redAttack = player.attack;
                    redDefense = player.defense;
                    redCrit = player.critical;
                    redElmAttack = player.elm_attack;
                    redElmDef = player.elm_defense;
                    redElmEffc = player.elm_efficiency;
                    redHp = player.hp;
                    redStr = player.strength;
                    redPot = player.potency;
                    redBuff = player.buff_acc;
                    redBuff2 = player.buff2_acc;
                    redELM = player.element
                    redRecovery = player.chakra_rec
                    redCost = player.cost

                } else if (val_2 === player.name) {
                    blueHtml = `
            <div class='fight_time_card'>
                <div class='fight_corner_header'>
                    <p>${player.name}</p>
                    <img class='elem_img_corner' src='${player.elm}'>
                </div>
                <img id='fight_corner_img' src='${player.image}'>
                <h4 contenteditable="true">🖤 <span id='blueHP'>${player.hp}</span></h4>
                <p>${player.nen_type}</p>
                <div class='fight_corner_stats'>
                    <p contenteditable="true">⚔️: <span id="blueAttack">${player.attack}</span></p>
                    <p contenteditable="true">🛡: <span id="blueDefense">${player.defense}</span></p>
                    <p contenteditable="true">💥: <span id="blueCrit">${player.critical}</span></p>
                    <p contenteditable="true">🔥: <span id="blueElmAttack">${player.elm_attack}</span></p>
                    <p contenteditable="true">㊏: <span id="blueElmDef">${player.elm_defense}</span></p>
                    <p contenteditable="true">🧪: <span id="blueElmEffc">${player.elm_efficiency}</span></p>
                    <p contenteditable="true">🪦: <span id="blueStr">${player.strength}</span></p>
                    <p contenteditable="true">🌪: <span id="bluePot">${player.potency}</span></p>
                     <p contenteditable="true">☸️: <span id="blueChakra">${player.chakra}</span></p>
                </div>
               <p>${player.chakra_attack} ✮ <span id='cost'>${player.cost}</span></p>
               <p>${player.buff} ✮ <span id='buff_red'>${player.buff_acc}%</span></p>
               <p>${player.buff2} ✮ <span id='buff_red'>${player.buff2_acc}%</span></p>
            </div>
            `;
                    blueAttack = player.attack;
                    blueDefense = player.defense;
                    blueCrit = player.critical;
                    blueElmAttack = player.elm_attack;
                    blueElmDef = player.elm_defense;
                    blueElmEffc = player.elm_efficiency;
                    blueHp = player.hp;
                    blueStr = player.strength;
                    bluePot = player.potency;
                    blueBuff = player.buff_acc
                    blueBuff2 = player.buff_acc2
                    blueELM = player.element
                    blueRecovery = player.chakra_rec
                    blueCost = player.cost
                }
            }

            $('#red_corner').html(redHtml);
            $('#blue_corner').html(blueHtml);

            console.log('Red Stats:', { redAttack, redDefense, redCrit, redElmAttack, redElmDef, redElmEffc, redHp, redStr, redPot });
            console.log('Blue Stats:', { blueAttack, blueDefense, blueCrit, blueElmAttack, blueElmDef, blueElmEffc, blueHp, blueStr, bluePot });
        }



        function filterSuggestions(inputId, suggestionsId, team) {
            $(inputId).on('input', function () {
                let filter = $(this).val().toLowerCase();
                let suggestions = $(suggestionsId);
                suggestions.empty(); // Clear previous suggestions

                if (filter) {
                    for (let player of team) {
                        if (player.name.toLowerCase().includes(filter)) {
                            suggestions.append(`<div>${player.name}</div>`);
                        }
                    }
                }

                // Handle clicking on a suggestion
                $(suggestionsId).on('click', 'div', function () {
                    $(inputId).val($(this).text()); // Set input to selected suggestion
                    suggestions.empty(); // Clear suggestions
                });
            });
        }

        // Apply filtering for red and blue corners
        filterSuggestions('#red_corner_search', '#red_corner_suggestions', databaseArr);
        filterSuggestions('#blue_corner_search', '#blue_corner_suggestions', databaseArr);


        $('#fight_form_fight').submit(action)
    </script>

</html>
