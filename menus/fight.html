<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>FIGHT</title>
        <script src="../database/players.js"></script>
        <script src="../database/database.js"></script>
        <link rel="stylesheet" href="menu.css">
        <link rel="stylesheet" href="../Teams/teams.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    </head>

    <body>
        <form id="fight_form_fight">
            <label for="red_corner_search">Red Corner</label>
            <input type="text" id="red_corner_search" placeholder="Type player's name">
            <div id="red_corner_suggestions" class="suggestions"></div>

            <label for="blue_corner_search">Blue Corner</label>
            <input type="text" id="blue_corner_search" placeholder="Type player's name">
            <div id="blue_corner_suggestions" class="suggestions"></div>
            <input type="submit">
        </form>

        <div class="corner_container">
            <div id="red_corner"></div>
            <div>
                <div>
                    <p id="crit"></p>
                    <p id="damage"></p>
                </div>
                <form id="attack-form">
                    <label>Turn</label>
                    <select id="attacker">
                        <option value="red">Red</option>
                        <option value="blue">Blue</option>
                    </select>
                    <lable>Action</lable>
                    <select id="actioner">
                        <option>Attack</option>
                        <option>Elemental Attack</option>
                        <option>Special Abbility</option>
                    </select>
                    <input type="submit">
                </form>
            </div>
            <div id="blue_corner"></div>
        </div>
    </body>

    <script>
        let databaseArr = database;
        let penn_state_team = penn_state;
        let ok_state_team = ok_state;
        let players_arr = [penn_state_team, ok_state_team];

        let blueAttack
        let blueDefense
        let blueCrit
        let blueElmAttack
        let blueElmDef
        let blueElmEffc
        let blueHp
        let blueStrength
        let bluePotency

        let redAttack
        let redDefense
        let redCrit
        let redElmAttack
        let redElmDef
        let redElmEffc
        let redHp
        let redStrength
        let redPotency
        function attack(e) {
            e.preventDefault();
            attacker = $('#attacker').val();
            action = $('#actioner').val();
            let currBlueHp = parseInt($('#blueHP').text(), 10);
            let currRedHp = parseInt($('#redHP').text(), 10);

            // Fetch and parse stats
            redAttack = parseInt($('#redAttack').text(), 10);
            redDefense = parseInt($('#redDefense').text(), 10);
            redCrit = parseFloat($('#redCritical').text()); // Ensure it's a float
            redElmAttack = parseInt($('#redElmAttack').text(), 10);
            redElmDef = parseInt($('#redElmDefense').text(), 10);
            redElmEffc = parseInt($('#redElmEfficiency').text(), 10);
            redHp = parseInt($('#redHP').text(), 10);
            redStr = parseInt($('#redStrength').text(), 10);
            redPot = parseInt($('#redPotency').text(), 10);

            blueAttack = parseInt($('#blueAttack').text(), 10);
            blueDefense = parseInt($('#blueDefense').text(), 10);
            blueCrit = parseFloat($('#blueCritical').text()); // Ensure it's a float
            blueElmAttack = parseInt($('#blueElmAttack').text(), 10);
            blueElmDef = parseInt($('#blueElmDefense').text(), 10);
            blueElmEffc = parseInt($('#blueElmEfficiency').text(), 10);
            blueHp = parseInt($('#blueHP').text(), 10);
            blueStr = parseInt($('#blueStrength').text(), 10);
            bluePot = parseInt($('#bluePotency').text(), 10);

            let variance = Math.random() * 0.2 - 0.1;
            if (action === 'Attack') {
                let isCritical;
                let criticalMultiplier;
                if (attacker === 'red') {
                    isCritical = Math.random() < redCrit;
                    criticalMultiplier = isCritical ? redStr : 1.0;
                    console.log(`Red Crit Chance: ${redCrit}, Is Critical: ${isCritical}`);
                    let damage = ((redAttack * (1 + variance)) - (blueDefense / 2)) * criticalMultiplier;
                    damage = Math.max(1, Math.round(damage));
                    $('#damage').text(damage);
                    $('#blueHP').text(currBlueHp - damage);
                    $('#crit').text(isCritical ? '💥🔥👊' : '');
                } else {
                    isCritical = Math.random() < blueCrit;
                    criticalMultiplier = isCritical ? blueStr : 1.0;
                    console.log(`Blue Crit Chance: ${blueCrit}, Is Critical: ${isCritical}`);
                    let damage = ((blueAttack * (1 + variance)) - (redDefense / 2)) * criticalMultiplier;
                    damage = Math.max(1, Math.round(damage));
                    $('#damage').text(damage);
                    $('#redHP').text(currRedHp - damage);
                    $('#crit').text(isCritical ? '💥🔥👊' : '');
                }
            }
        }

        $('#attack-form').submit(attack);


        $('#attack-form').submit(attack)

        function action(e) {
            e.preventDefault();
            let val_1 = $('#red_corner_search').val();
            let val_2 = $('#blue_corner_search').val();

            let redHtml = '';
            let blueHtml = '';

            for (let player of databaseArr) {
                if (val_1 === player.name) {
                    console.log(player);
                    redHtml = `
                <div class='fight_time_card'>
                    <div class='fight_corner_header'>
                        <p>${player.name}</p>
                        <img class='elem_img_corner' src='${player.elm}'>
                    </div>
                    <img class='corner_img' src='${player.image}'>
                    <h4 contenteditable="true">🖤 <span class="hp" id='redHP'>${player.hp}</span></h4>
                    <div class='fight_corner_stats'>
                        <p contenteditable="true">⚔️: <span class="stat" id="redAttack">${player.attack}</span></p>
                        <p contenteditable="true">🛡: <span class="stat" id="redDefense">${player.defense}</span></p>
                        <p contenteditable="true">💥: <span class="stat" id="redCritical">${player.critical}</span></p>
                        <p contenteditable="true">🔥: <span class="stat" id="redElmAttack">${player.elm_attack}</span></p>
                        <p contenteditable="true">㊏: <span class="stat" id="redElmDefense">${player.elm_defense}</span></p>
                        <p contenteditable="true">🧪: <span class="stat" id="redElmEfficiency">${player.elm_efficiency}</span></p>
                        <p contenteditable="true">🪦: <span class="stat" id="redStrength">${player.strength}</span></p>
                        <p contenteditable="true">🌪: <span class="stat" id="redPotency">${player.potency}</span></p>
                    </div>
                </div>
            `;
                } else if (val_2 === player.name) {
                    console.log(player);
                    blueHtml = `
                <div class='fight_time_card'>
                    <div class='fight_corner_header'>
                        <p>${player.name}</p>
                        <img class='elem_img_corner' src='${player.elm}'>
                    </div>
                    <img class='corner_img' src='${player.image}'>
                    <h4 contenteditable="true">🖤 <span class="hp" id='blueHP'>${player.hp}</span></h4>
                    <div class='fight_corner_stats'>
                        <p contenteditable="true">⚔️: <span class="stat" id="blueAttack">${player.attack}</span></p>
                        <p contenteditable="true">🛡: <span class="stat" id="blueDefense">${player.defense}</span></p>
                        <p contenteditable="true">💥: <span class="stat" id="blueCritical">${player.critical}</span></p>
                        <p contenteditable="true">🔥: <span class="stat" id="blueElmAttack">${player.elm_attack}</span></p>
                        <p contenteditable="true">㊏: <span class="stat" id="blueElmDefense">${player.elm_defense}</span></p>
                        <p contenteditable="true">🧪: <span class="stat" id="blueElmEfficiency">${player.elm_efficiency}</span></p>
                        <p contenteditable="true">🪦: <span class="stat" id="blueStrength">${player.strength}</span></p>
                        <p contenteditable="true">🌪: <span class="stat" id="bluePotency">${player.potency}</span></p>
                    </div>
                </div>
            `;
                }
            }

            $('#red_corner').html(redHtml);
            $('#blue_corner').html(blueHtml);

            // Ensure values are read after the HTML is updated
            redAttack = parseInt($('#redAttack').text(), 10);
            redDefense = parseInt($('#redDefense').text(), 10);
            redCrit = parseInt($('#redCritical').text(), 10);
            redElmAttack = parseInt($('#redElmAttack').text(), 10);
            redElmDef = parseInt($('#redElmDefense').text(), 10);
            redElmEffc = parseInt($('#redElmEfficiency').text(), 10);
            redHp = parseInt($('#redHP').text(), 10);
            redStr = parseInt($('#redStrength').text(), 10);
            redPot = parseInt($('#redPotency').text(), 10);

            blueAttack = parseInt($('#blueAttack').text(), 10);
            blueDefense = parseInt($('#blueDefense').text(), 10);
            blueCrit = parseInt($('#blueCritical').text(), 10);
            blueElmAttack = parseInt($('#blueElmAttack').text(), 10);
            blueElmDef = parseInt($('#blueElmDefense').text(), 10);
            blueElmEffc = parseInt($('#blueElmEfficiency').text(), 10);
            blueHp = parseInt($('#blueHP').text(), 10);
            blueStr = parseInt($('#blueStrength').text(), 10);
            bluePot = parseInt($('#bluePotency').text(), 10);

            console.log('Red Stats:', redAttack, redDefense);
            console.log('Blue Stats:', blueAttack, blueDefense);
        }


        function filterSuggestions(inputId, suggestionsId, team) {
            $(inputId).on('input', function () {
                let filter = $(this).val().toLowerCase();
                let suggestions = $(suggestionsId);
                suggestions.empty(); // Clear previous suggestions

                if (filter) {
                    for (let player of team) {
                        if (player.name.toLowerCase().includes(filter)) {
                            suggestions.append(`<div>${player.name}</div>`);
                        }
                    }
                }

                // Handle clicking on a suggestion
                $(suggestionsId).on('click', 'div', function () {
                    $(inputId).val($(this).text()); // Set input to selected suggestion
                    suggestions.empty(); // Clear suggestions
                });
            });
        }

        // Apply filtering for red and blue corners
        filterSuggestions('#red_corner_search', '#red_corner_suggestions', databaseArr);
        filterSuggestions('#blue_corner_search', '#blue_corner_suggestions', databaseArr);


        $('#fight_form_fight').submit(action)
    </script>

</html>
